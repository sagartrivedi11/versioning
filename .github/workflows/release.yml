# .github/workflows/release.yml
name: Automated Release with Semantic-Release

on:
  push:
    branches:
      - main # The branch you release from

jobs:
  release:
    name: Create Semantic Release
    runs-on: ubuntu-latest

    permissions:
      contents: write # Ensure write permissions for creating tags, releases, and pushing branches

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # CRUCIAL: Fetch all history for semantic-release

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Use a stable Node.js version
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run semantic-release
        id: semantic_release_step # Keep this ID
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "--- Starting semantic-release execution ---"

          # Create a temporary file to store all output from semantic-release
          TEMP_OUTPUT_FILE=$(mktemp)

          # Run semantic-release, capturing ALL output (stdout and stderr) to the temporary file
          npx semantic-release --json > "$TEMP_OUTPUT_FILE" 2>&1
          SEMANTIC_RELEASE_EXIT_CODE=$?

          echo "--- Debugging semantic-release Output ---"
          echo "Full raw output from semantic-release (from temp file):"
          cat "$TEMP_OUTPUT_FILE" # Print the full content of the temp file for debugging
          echo "Semantic-release Exit Code: $SEMANTIC_RELEASE_EXIT_CODE"

          # Extract the last non-empty line from the temporary file.
          # This is where semantic-release's JSON output (or 'null') should be.
          # 'xargs' is used to strip leading/trailing whitespace.
          RAW_JSON_LINE=$(grep -vE '^\s*$' "$TEMP_OUTPUT_FILE" | tail -n 1 | xargs)

          # Clean up the temporary file
          rm "$TEMP_OUTPUT_FILE"

          echo "Raw JSON line extracted for parsing: '$RAW_JSON_LINE'"

          NEW_VERSION="" # Initialize NEW_VERSION

          # Check if RAW_JSON_LINE is non-empty AND valid JSON (either an object or 'null')
          if [ -n "$RAW_JSON_LINE" ] && (echo "$RAW_JSON_LINE" | jq . > /dev/null 2>&1 || [ "$RAW_JSON_LINE" = "null" ]); then
            # If it's 'null', it means no release was published.
            if [ "$RAW_JSON_LINE" = "null" ]; then
              echo "semantic-release indicated no new release (output was 'null')."
              NEW_VERSION="" # Explicitly keep NEW_VERSION empty
            else
              # It's a JSON object, try to extract the version.
              NEW_VERSION=$(echo "$RAW_JSON_LINE" | jq -r '.nextRelease.version // empty')
              echo "Parsed NEW_VERSION: '$NEW_VERSION'"
            fi
          else
            echo "Semantic-release did not produce a valid JSON release object on the last relevant line."
            echo "  - Is RAW_JSON_LINE empty? [$( [ -z "$RAW_JSON_LINE" ] && echo "YES" || echo "NO" )]"
            echo "  - Is RAW_JSON_LINE valid JSON? [$( echo "$RAW_JSON_LINE" | jq . > /dev/null 2>&1 && echo "YES" || echo "NO" )]"
          fi

          echo "--- End Debugging ---"

          # Set the new_release_version as a step output for GitHub Actions
          echo "new_release_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Set GitHub Actions output 'new_release_version' to: '$NEW_VERSION'"


      - name: Create Release Branch
        # This step will now correctly receive the new_release_version output
        # and will only run if new_release_version is not empty.
        if: steps.semantic_release_step.outputs.new_release_version
        run: |
          echo "--- Starting Create Release Branch step ---"
          # Get the new version number from semantic-release's output
          VERSION="${{ steps.semantic_release_step.outputs.new_release_version }}"
          RELEASE_BRANCH="release/v${VERSION}"
          echo "Attempting to create and push branch: $RELEASE_BRANCH"

          # Configure Git with the GitHub Actions bot identity
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all tags to ensure the newly created tag is available locally
          git fetch --tags

          # Create the new branch from the tag semantic-release just created
          git branch $RELEASE_BRANCH "v${VERSION}"

          # Push the new branch to the remote repository
          git push origin $RELEASE_BRANCH
          echo "--- Finished Create Release Branch step ---"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Ensure token is available for git push